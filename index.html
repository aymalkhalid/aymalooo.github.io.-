<!DOCTYPE html>
<html>
<head>
    <title>Home</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
   <!-- Add this right after the opening <body> tag -->
  <div id="modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <h2>Welcome to DISH Agent</h2>
      <p>Please enter your information to continue</p>
      
      <form id="user-info-form">
        <div class="form-group">
          <label for="firstName">Applicant Name</label>
          <input type="text" id="firstName" name="firstName" required>
        </div>
        
        <div class="form-group">
          <label for="position">Applicant Position</label>
          <input type="text" id="position" name="position" required>
        </div>
        
        <div class="form-group">
          <label for="lastJob">Last Job Company</label>
          <input type="text" id="lastJob" name="lastJob" required>
        </div>
        
        <button type="submit" class="submit-btn">Start Conversation</button>
      </form>
    </div>
  </div>
   <!--End of Popup  -->
    <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">
    <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>
    <df-messenger
      project-id="agent-demos-v1"
      agent-id="fa47c7e0-4ea7-431d-ba0f-a62126f4070a"
      language-code="en"
      max-query-length="-1"
      allow-feedback="all"
      intent="WELCOME"
      >
      <df-messenger-chat
       chat-title="Hybrid DISH Agent"
       >
      </df-messenger-chat>
    </df-messenger>
    <button id="start-voice-input" class="voice-button">
      <i class="fas fa-microphone"></i>
    </button>
    <div id="speech-status" style="position: fixed; bottom: 115px; right: 20px; color: #007bff; font-weight: bold; background-color: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 5px; display: none;"></div>
        <!-- Add this new element right after the speech-status div -->
    <div id="transcription-display" style="position: fixed; bottom: 100px; left: 20px; color: #333; font-weight: bold; background-color: rgba(255,255,255,0.95); padding: 12px 15px; border-radius: 8px; max-width: 80%; width: 400px; text-align: left; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 4px solid #007bff; z-index: 1100; display: none; transition: all 0.3s ease;"></div>
    <div id="error-message" style="position: fixed; bottom: 85px; right: 20px; color: red;"></div>
    <style>
      df-messenger {
        z-index: 999;
        position: fixed;
        --df-messenger-font-color: #000;
        --df-messenger-font-family: Google Sans;
        --df-messenger-chat-background: #f3f6fc;
        --df-messenger-message-user-background: #d3e3fd;
        --df-messenger-message-bot-background: #fff;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 80%;
        height: 100%;
      }
      .voice-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .voice-button:focus {
        outline: none;
      }
      .voice-button.listening {
        background-color: #ff0000;
        animation: pulse-animation 1s infinite;
      }
      .pulse {
        animation: pulse-animation 2s infinite;
      }
      @keyframes pulse-animation {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }
      .feedback-wrapper {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
      }
      .feedback-wrapper label {
        display: flex;
        align-items: center;
      }
      .feedback-wrapper input[type="checkbox"] {
        margin-right: 10px;
      }
      .feedback-wrapper button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }
      .feedback-wrapper button:hover {
        background-color: #0056b3;
      }
      .feedback-wrapper button:focus {
        outline: none;
      }
      .feedback-wrapper textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        resize: vertical;
      }
      .feedback-wrapper textarea:focus {
        border-color: #007bff;
        outline: none;
      }
      /* Speech Status indicator */
      #speech-status {
        transition: opacity 0.3s ease;
        opacity: 0.9;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      
      @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      #speech-status.listening {
        animation: blink 1.5s infinite;
      }
      /* Modal overlay styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      
      .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      
      .modal-content h2 {
        margin-top: 0;
        color: #007bff;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      
      .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
      }
      
      .submit-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
      }
      
      .submit-btn:hover {
        background-color: #0056b3;
      }
      
      /* Blur effect class */
      .blur-background {
        filter: blur(5px);
      }
    </style>
<!--  -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Apply blur to background elements
      const dfMessenger = document.querySelector('df-messenger');
      const voiceButton = document.getElementById('start-voice-input');
      
      dfMessenger.classList.add('blur-background');
      voiceButton.classList.add('blur-background');
      
      // Handle form submission
      const userInfoForm = document.getElementById('user-info-form');
      userInfoForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Get form values
        const firstName = document.getElementById('firstName').value.trim();
        const position = document.getElementById('position').value.trim();
        const lastJob = document.getElementById('lastJob').value.trim();
        
        // Validate inputs
        if (!firstName || !position || !lastJob) {
          alert('Please fill in all fields');
          return;
        }
        
        // Store values in global variables to be used by setUserInformation
        window.userInfo = {
          firstName: firstName,
          position: position,
          lastJob: lastJob
        };
        
        // Remove blur effect
        dfMessenger.classList.remove('blur-background');
        voiceButton.classList.remove('blur-background');
        
        // Hide modal
        document.getElementById('modal-overlay').style.display = 'none';
        
        // Initialize the chatbot with user info
        initializeAgent();
      });
    });
    
    function initializeAgent() {
      // This function will be called after form submission
      // It will replace the immediate setUserInformation call
      setUserInformation();
    }
  </script>
<!-- //  -->
<script>
  const startVoiceInputButton = document.getElementById('start-voice-input');
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.continuous = true;
  let isRecognitionActive = false;
  let currentTranscript = ''; // Store transcript while listening
  let allTranscripts = []; // Keep all transcription segments
  
  function showListeningStatus(isListening) {
    const speechStatus = document.getElementById('speech-status');
    if (isListening) {
      speechStatus.textContent = "Listening...";
      speechStatus.style.display = "block";
      speechStatus.classList.add('listening');
    } else {
      speechStatus.style.display = "none";
      speechStatus.classList.remove('listening');
    }
  }
  
  startVoiceInputButton.addEventListener('click', () => {
    if (!isRecognitionActive) {
      // Start listening
      currentTranscript = ''; // Clear any previous transcript
      allTranscripts = []; // Reset the transcript segments array
      startVoiceInputButton.innerHTML = '<i class="fas fa-stop"></i>';
      startVoiceInputButton.classList.add('listening');
      recognition.start();
      isRecognitionActive = true;
      showListeningStatus(true);
      
      // Clear any previous transcription display but keep it visible with a placeholder
      const transcriptionDisplay = document.getElementById('transcription-display');
      transcriptionDisplay.innerHTML = '<i class="fas fa-comment-dots" style="margin-right: 8px; color: #007bff;"></i> <span style="color: #007bff;">Listening for speech...</span>';
      transcriptionDisplay.style.display = 'block';
    } else {
      // Stop listening and send complete transcript
      recognition.stop();
      isRecognitionActive = false;
      startVoiceInputButton.innerHTML = '<i class="fas fa-microphone"></i>';
      startVoiceInputButton.classList.remove('listening');
      showListeningStatus(false);
      
      // Get the full transcript from all segments
      const fullTranscript = allTranscripts.join(' ').trim();
      
      // Only send transcript when stopping if we have content
      if (fullTranscript) {
        const dfMessenger = document.querySelector('df-messenger');
        dfMessenger.renderCustomText(fullTranscript, false);
        dfMessenger.sendRequest('query', fullTranscript);
        console.log("Sending transcript to Dialogflow:", fullTranscript);
      }
      
      // Reset transcripts
      currentTranscript = '';
      allTranscripts = [];
      
      // Clear and hide the transcription display
      const transcriptionDisplay = document.getElementById('transcription-display');
      transcriptionDisplay.innerHTML = '';
      transcriptionDisplay.style.display = 'none';
    }
  });

  // Collect transcripts while listening, don't send them
  // Collect transcripts while listening, don't send them
  // Collect transcripts while listening, don't send them
  recognition.addEventListener('result', (event) => {
    const latestTranscript = event.results[event.results.length - 1][0].transcript;
    currentTranscript = latestTranscript; // Store latest transcript
    
    // Add to our collection of transcript segments
    allTranscripts.push(latestTranscript);
    
    // Show what's being transcribed without sending to agent
    const transcriptionDisplay = document.getElementById('transcription-display');
    
    // Create formatted content with icon
    transcriptionDisplay.innerHTML = `<i class="fas fa-comment-dots" style="margin-right: 8px; color: #007bff;"></i> 
                                    <span style="color: #007bff;">Transcribing:</span> 
                                    <span style="font-weight: normal;">${currentTranscript}</span>`;
    
    // Make sure it's visible
    transcriptionDisplay.style.display = 'block';
    
    console.log("Added transcript segment:", latestTranscript);
  });

  recognition.addEventListener('end', () => {
    if (isRecognitionActive) {
      // Immediately restart recognition to maintain continuous listening
      setTimeout(() => {
        try {
          recognition.start();
          console.log('Speech recognition restarted');
        } catch (error) {
          console.error('Error restarting speech recognition:', error);
          isRecognitionActive = false;
          startVoiceInputButton.innerHTML = '<i class="fas fa-microphone"></i>';
          startVoiceInputButton.classList.remove('listening');
          showListeningStatus(false);
        }
      }, 10);
    }
  });

  recognition.addEventListener('error', (event) => {
    console.error('Speech recognition error detected: ' + event.error);
    const errorMessage = document.getElementById('error-message');
    
    // Don't stop listening for common errors
    switch (event.error) {
      case 'no-speech':
        errorMessage.textContent = 'No speech detected.';
        break;
      case 'audio-capture':
        errorMessage.textContent = 'Microphone access denied or not available.';
        stopRecognition();
        break;
      case 'not-allowed':
        errorMessage.textContent = 'Permission to use the microphone was denied.';
        stopRecognition();
        break;
      default:
        errorMessage.textContent = 'An error occurred during speech recognition.';
        if (event.error !== 'aborted') {
          stopRecognition();
        }
    }
    
    // Clear error message after 3 seconds only for errors, not for transcription display
    if (event.error) {
      setTimeout(() => {
        if (errorMessage.textContent.startsWith('Transcribing:') === false) {
          errorMessage.textContent = '';
          errorMessage.style.color = 'red'; // Reset to error color
        }
      }, 3000);
    }
  });
  
  function stopRecognition() {
    isRecognitionActive = false;
    startVoiceInputButton.innerHTML = '<i class="fas fa-microphone"></i>';
    startVoiceInputButton.classList.remove('listening');
    showListeningStatus(false);
    currentTranscript = ''; // Clear transcript when stopping
    allTranscripts = []; // Clear all transcript segments
  }
</script>
<!--  -->
<script>
  // Global arrays to store feedback text and selected options
  const feedbackTextsList = [];
  const selectedOptionsList = [];
  class CustomFeedbackElement extends HTMLElement {
    constructor() {
      super();
      this.renderRoot = this.attachShadow({ mode: 'open' });
    }

    connectedCallback() {
      const wrapper = document.createElement('div');
      wrapper.classList.add('feedback-wrapper');

      // Create feedback options
      const options = [
        "Inaccurate", "Partially Accurate", "Unhelpful", "Context Lost", "Unnatural Language", "Repetitive", "Edge Case Failure", "Human Escalation Needed"
      ];

      options.forEach(option => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = option;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(option));
        wrapper.appendChild(label);
      });

      // Create text area for manual feedback
      // Add a Break
      wrapper.appendChild(document.createElement('br'));
      wrapper.appendChild(document.createElement('br'));
      const textArea = document.createElement('textarea');
      
      textArea.placeholder = 'Enter your feedback here...';
      textArea.style.width = '100%';
      textArea.style.height = '100px';
      textArea.id = 'feedback-text';
      wrapper.appendChild(textArea);

      // Create submit button
      const button = document.createElement('button');
      button.innerText = 'Submit';
      button.addEventListener('click', () => {
        this._onSubmitClick();
      });
      wrapper.appendChild(button);

      this.renderRoot.appendChild(wrapper);
    }

    _onSubmitClick() {
      const feedbackText = this.renderRoot.getElementById('feedback-text').value;
      const checkboxes = this.renderRoot.querySelectorAll('input[type="checkbox"]');
      const selectedOptions = Array.from(checkboxes)
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);
      
      // Append feedback to global arrays
      feedbackTextsList.push(feedbackText);
      selectedOptionsList.push(selectedOptions);

      const event = new CustomEvent("df-custom-submit-feedback-clicked", {
        detail: JSON.stringify({
          "feedback": feedbackTextsList,
          "selectedOptions": selectedOptionsList
        }),
        bubbles: true,
        composed: true,
      });
      this.dispatchEvent(event);
    }
  }

  (function() {customElements.define('df-external-custom-feedback', CustomFeedbackElement);})();

  // Add event listener to log feedback to console
  document.addEventListener('df-custom-submit-feedback-clicked', (event) => {
    console.log('Feedback submitted:', event.detail); 
    // Feedback submitted: {"feedback":"","selectedOptions":["Unhelpful"]}
    //Access the feedback and selected options
    const feedback = JSON.parse(event.detail);
    funsetQueryParameters(feedback.feedback, feedback.selectedOptions);
  });
</script>
<!--  -->
<script>
  // Initialize voices array and tracking variables
  let speechSynthesisVoices = [];
  let voicesLoaded = false;
  let isFirstResponse = true;
  let FlagWelcome = 0;
  let AIMessage = '';
  
  // Enhanced function to load and cache voices
  function loadVoices() {
    console.log('Loading voices...');
    speechSynthesisVoices = window.speechSynthesis.getVoices();
    voicesLoaded = speechSynthesisVoices.length > 0;
    console.log(`${speechSynthesisVoices.length} voices loaded, voicesLoaded=${voicesLoaded}`);
    return voicesLoaded;
  }
  
  // Load voices on page load
  loadVoices();
  
  // Set up event handler for when voices are ready
  if (window.speechSynthesis.onvoiceschanged !== undefined) {
    window.speechSynthesis.onvoiceschanged = function() {
      voicesLoaded = loadVoices();
      console.log('Voices changed event triggered');
    };
  }

  // Add this function to show a speech status indicator
  function showSpeechStatus(isSpeaking) {
    const speechStatus = document.getElementById('speech-status');
    if (isSpeaking) {
      speechStatus.textContent = "Speaking...";
      speechStatus.style.display = "block";
    } else {
      speechStatus.style.display = "none";
    }
  }
  
  function speakText(text) {
    if (!text || typeof text !== 'string') {
      console.log('Invalid text to speak:', text);
      return;
    }
    
    console.log('Speaking:', text);
    
    // Cancel any ongoing speech
    window.speechSynthesis.cancel();
    
    const utterance = new SpeechSynthesisUtterance(text);
    
    // Use cached voices or get voices again
    const voices = speechSynthesisVoices.length > 0 ? 
      speechSynthesisVoices : window.speechSynthesis.getVoices();
    
    // Find Google US English voice
    const selectedVoice = voices.find(voice => voice.name === 'Google US English');
    console.log("Selected voice:", selectedVoice ? selectedVoice.name : "Voice not found");
    
    if (selectedVoice) {
      utterance.voice = selectedVoice;
    } else {
      // Fallback to any US English voice if Google's isn't available
      const fallbackVoice = voices.find(voice => voice.lang === 'en-US');
      if (fallbackVoice) {
        utterance.voice = fallbackVoice;
        console.log("Using fallback voice:", fallbackVoice.name);
      }
    }
    
    utterance.lang = 'en-US';
    utterance.rate = 1.0;
    utterance.pitch = 1.2;
    
    // Add event handlers to track speech progress AND update speech status indicator
    utterance.onstart = () => {
      console.log('Started speaking');
      showSpeechStatus(true);
    };
    
    utterance.onend = () => {
      console.log('Finished speaking');
      showSpeechStatus(false);
    };
    
    utterance.onerror = (err) => {
      console.error('Speech synthesis error:', err);
      showSpeechStatus(false);
    };
    
    window.speechSynthesis.speak(utterance);
  }
  
  const dfMessenger = document.querySelector('df-messenger');
  dfMessenger.addEventListener('df-response-received', (event) => {
    console.log(`Response received (isFirstResponse=${isFirstResponse}):`, 
      event.detail.raw.queryResult.diagnosticInfo);
    
    // Handle response data
    const responseData = event.detail;
    
    // Process the message with highest priority
    if (responseData.messages && responseData.messages.length > 0) {
      console.log('Message:', responseData.messages[0].text);
      AIMessage = responseData.messages[0].text;
      
      if (isFirstResponse) {
        isFirstResponse = false;
        console.log('Processing first response with special handling');
        
        // For the first response, ensure voices are loaded with a small delay
        if (!voicesLoaded) {
          loadVoices();
          setTimeout(() => {
            speakText(AIMessage);
          }, 300);  // Extra delay for first response
        } else {
          speakText(AIMessage);
        }
      } else {
        // Normal processing for subsequent responses
        speakText(AIMessage);
      }
    }
    
    // Handle initialization (if needed)
    if (FlagWelcome === 0 && window.userInfo) {
      FlagWelcome = 1;  // Set flag immediately to prevent race conditions
      setUserInformation();
    }
  });
  
  function setUserInformation() {
    const dfMessenger = document.querySelector('df-messenger');
    console.log("Setting user parameters");
    
    // Get user info from the form (or use defaults if somehow missing)
    const userInfo = window.userInfo || {
      firstName: "Guest",
      position: "Visitor",
      lastJob: "Unknown"
    };
    
    const queryParameters = {
      parameters: {
        job_applicant_first_name: userInfo.firstName,
        job_applicant_position: userInfo.position,
        job_applicant_last_Job: userInfo.lastJob,
      }
    };
    
    dfMessenger.setQueryParameters(queryParameters);
    console.log("Parameters set successfully:", userInfo);
    console.log("Flag", FlagWelcome);
    if (FlagWelcome === 0) 
    {
      // Send a welcome message after setting user parameters
      // This is to ensure the welcome message is personalized
      console.log("Sending welcome message");
      dfMessenger.sendRequest('query', 'Hello');
      FlagWelcome = 2;
    }
  }
  
  function funsetQueryParameters(feedbackTextsList, selectedOptionsList) {
    const dfMessenger = document.querySelector('df-messenger');
    const queryParameters = {
      parameters: {
        feedbackTextsList: feedbackTextsList,
        selectedOptionsList: selectedOptionsList
      }
    };
    dfMessenger.setQueryParameters(queryParameters);  
    console.log("Set query parameters with feedback and selected options");
    console.log("Feedback Texts List: ", feedbackTextsList);
    console.log("Selected Options List: ", selectedOptionsList);
    console.log("AI Message: ", AIMessage);
  }
</script>
</body>
</html>
